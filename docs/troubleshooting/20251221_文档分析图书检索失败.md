# 故障复盘报告
- **日期**: 2025-12-21
- **严重级别**: Medium

## 1. 问题现象
文档上传完成并生成交叉分析报告后，点击“确认检索”立即在控制台报错“文档分析图书检索失败”，流程被中断，无法进入书籍选择阶段。

## 2. 根本原因 (Root Cause)
因为前端未把文档分析阶段生成的用户输入上下文写入 `documentAnalysisUserInput`，导致触发 `/api/local-aibot/document-analysis/book-search` 时携带的 `userInput` 参数为空字符串。后端接口在 `app/api/local-aibot/document-analysis/book-search/route.ts` 中严格校验该字段，空值直接返回 400，前端 `response.ok` 判定失败后抛出异常，所以一直报错。

## 3. 解决方案
- 在 `components/aibot/AIBotOverlay.tsx` 的 `executeDocumentAnalysis` 中，生成默认的“文档分析：xxx”提示并立即调用 `setDocumentAnalysisUserInput` 保存。
- 当 SSE 返回 `draft-start` 事件并提供了更精准的 `userInput` 时，覆盖前述默认值并再次写入 store，所有草稿消息展示都复用该变量。
- `handleDocumentAnalysisDraftConfirm` 因此能够携带真实的用户输入触发图书检索，后端校验通过。

## 4. 预防措施
- 在新增文档分析或深度检索扩展时，统一通过状态管理设置 `userInput`，避免直接拼接字符串。
- 在文档上传流程的回归用例中增加“确认检索”步骤验证，确保图书检索接口能够收到完整参数。
