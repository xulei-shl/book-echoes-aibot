# 深度检索流程测试指南

## 概述

本文档描述了新实现的深度检索流程的完整测试步骤和预期行为。

## 新增组件

### 1. DeepSearchKeywordGenerator
- **文件**: `components/aibot/DeepSearchKeywordGenerator.tsx`
- **功能**: 将用户输入的原始文本经过大模型分析生成适用于网络检索的关键词列表
- **API**: `/api/local-aibot/generate-keywords`

### 2. DraftConfirmationDisplay
- **文件**: `components/aibot/DraftConfirmationDisplay.tsx`
- **功能**: 重新设计的草稿确认markdown显示组件，参考BookItem.tsx的折叠展开样式
- **特点**: 
  - 显示位置在用户输入下面
  - 支持源数据查看
  - 可编辑调整草稿内容

### 3. DeepSearchBookList
- **文件**: `components/aibot/DeepSearchBookList.tsx`
- **功能**: 深度检索图书列表显示组件，重用BookItem.tsx样式
- **特点**: 支持图书选择和解析功能

### 4. DeepSearchWorkflow
- **文件**: `components/aibot/DeepSearchWorkflow.tsx`
- **功能**: 整合所有深度检索组件的主工作流
- **阶段**: keywords → draft → search → selection → interpretation → completed

## 新增API端点

### 1. 关键词生成API
- **路径**: `/api/local-aibot/generate-keywords`
- **方法**: POST
- **输入**: `{ user_input: string }`
- **输出**: `{ success: boolean, keywords: KeywordResult[] }`

### 2. 深度检索API
- **路径**: `/api/local-aibot/deep-search`
- **方法**: POST
- **输入**: `{ keywords: KeywordResult[], userInput: string }`
- **输出**: `{ success: boolean, draftMarkdown: string, searchSnippets: [], retrievalResult: RetrievalResultData }`

### 3. 深度解读API
- **路径**: `/api/local-aibot/deep-interpretation`
- **方法**: POST
- **输入**: `{ selectedBooks: BookInfo[], draftMarkdown: string, originalQuery: string }`
- **输出**: `{ success: boolean, interpretation: string }`

## 测试步骤

### 步骤1: 启动深度检索
1. 打开AIBot对话框
2. 确保开启"深度检索"模式
3. 输入测试查询，例如："影像与记忆_电影作为文明存续的时间容器"
4. 点击"开始深度检索"按钮

**预期结果**: 
- 显示DeepSearchWorkflow组件
- 进入关键词生成阶段
- 调用关键词生成API

### 步骤2: 关键词生成测试
1. 等待关键词生成完成
2. 检查生成的关键词是否合理
3. 可以点击"重新生成"测试不同结果

**预期结果**:
- 显示5-8个关键词
- 每个关键词包含理由和优先级
- 支持高、中、低优先级分类

### 步骤3: 草稿确认测试
1. 关键词生成完成后，自动进入草稿确认阶段
2. 检查草稿内容是否基于关键词分析生成
3. 可以点击"源数据"查看检索摘要
4. 尝试编辑草稿内容
5. 点击"确认检索"

**预期结果**:
- 草稿内容基于交叉分析生成
- 支持查看源数据
- 支持编辑调整
- 确认后进入图书检索

### 步骤4: 图书检索测试
1. 等待图书检索完成
2. 检查返回的图书列表
3. 尝试选择不同的图书
4. 测试"自动筛选"功能
5. 点击"生成深度解读"

**预期结果**:
- 显示相关图书列表
- 支持多选图书
- 自动筛选基于相似度>0.4
- 解读生成时显示加载状态

### 步骤5: 解读生成测试
1. 等待深度解读生成完成
2. 检查解读内容是否结合了草稿和选中图书
3. 验证解读格式是否符合推荐导语要求

**预期结果**:
- 解读内容基于`public/prompts/推荐导语.md`生成
- 包含标题、策展人手记、阅读谱系、结语
- 内容与选中的图书和草稿相关

## 错误处理测试

### 1. 网络错误
- 断开网络连接
- 尝试执行深度检索
- 验证错误提示和回退机制

### 2. API错误
- 模拟API返回错误
- 验证错误处理逻辑
- 检查用户体验

### 3. 空输入测试
- 输入空内容
- 点击深度检索
- 验证输入验证

## 性能测试

### 1. 大量关键词测试
- 输入复杂查询
- 验证关键词生成性能
- 检查内存使用

### 2. 大量图书测试
- 验证图书列表渲染性能
- 检查滚动和选择性能

## 兼容性测试

### 1. 浏览器兼容性
- Chrome、Firefox、Safari、Edge
- 验证组件渲染和交互

### 2. 响应式测试
- 不同屏幕尺寸
- 移动端适配
- 触摸交互

## 回归测试

### 1. 简单检索功能
- 确保简单检索不受影响
- 验证原有功能正常

### 2. 原有深度检索
- 验证原有深度检索模式仍然可用
- 检查向后兼容性

## 日志和调试

### 关键日志点
1. 关键词生成开始/完成
2. 深度检索开始/完成
3. 草稿确认操作
4. 图书选择变化
5. 解读生成开始/完成

### 调试信息
- 组件状态变化
- API调用参数
- 错误详情
- 性能指标

## 验收标准

### 功能完整性
- ✅ 所有新增组件正常工作
- ✅ API端点响应正确
- ✅ 工作流程顺畅
- ✅ 错误处理完善

### 用户体验
- ✅ 界面响应流畅
- ✅ 操作逻辑清晰
- ✅ 加载状态明确
- ✅ 错误提示友好

### 性能表现
- ✅ 响应时间合理
- ✅ 内存使用正常
- ✅ 渲染性能良好
- ✅ 网络请求优化

## 已知问题

1. **TypeScript类型问题**: 部分AI SDK参数类型可能需要调整
2. **错误恢复**: 某些错误场景下的恢复机制需要完善
3. **缓存机制**: 可以考虑添加结果缓存提升性能

## 后续优化建议

1. **进度持久化**: 保存深度检索进度，支持中断恢复
2. **结果缓存**: 缓存关键词和检索结果
3. **批量操作**: 支持批量关键词检索
4. **个性化**: 基于用户历史优化关键词生成