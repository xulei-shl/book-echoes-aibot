# ç¬¬äº”ç« èŠ‚é—®é¢˜ï¼šæ¨¡å—4ï¼ˆAIBot æ™ºæœç³»ç»Ÿï¼‰ä»£ç å®ç°è¯¦è§£

> åŸºäºå®é™…ä»£ç åˆ†æï¼Œå›ç­”å…³äº"äººåœ¨ç¯äº¤äº’"å’Œ"å¤šæ¨¡å¼é›†æˆ"çš„æ ¸å¿ƒé—®é¢˜

---

## é—®é¢˜1ï¼š"äººåœ¨ç¯ï¼ˆHITLï¼‰"ä»£ç é€»è¾‘

### 1.1 çŠ¶æ€æœºè®¾è®¡

ç³»ç»Ÿåœ¨ [`DeepSearchWorkflow.tsx`](components/aibot/DeepSearchWorkflow.tsx:28) ä¸­å®šä¹‰äº†å®Œæ•´çš„é˜¶æ®µçŠ¶æ€æœºï¼š

```typescript
type DeepSearchPhase = 'analysis' | 'draft' | 'search' | 'selection' | 'interpretation' | 'completed';
```

**çŠ¶æ€æµè½¬å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚analysis â”‚â”€â”€â”€â”€â–¶â”‚  draft  â”‚â”€â”€â”€â”€â–¶â”‚  search â”‚â”€â”€â”€â”€â–¶â”‚selectionâ”‚â”€â”€â”€â”€â–¶â”‚interpre-â”‚â”€â”€â”€â”€â–¶â”‚completedâ”‚
â”‚  åˆ†æ   â”‚     â”‚  è‰ç¨¿   â”‚     â”‚  æ£€ç´¢   â”‚     â”‚  é€‰æ‹©   â”‚     â”‚  tation â”‚     â”‚  å®Œæˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  è§£è¯»   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚               â”‚               â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼               â–¼
  è‡ªåŠ¨ç”Ÿæˆ         ç”¨æˆ·ç¡®è®¤       å›¾ä¹¦æ£€ç´¢        å›¾ä¹¦é€‰æ‹©
  å…³é”®è¯æ£€ç´¢      ç¼–è¾‘è‰ç¨¿        åŸºäºè‰ç¨¿        AIè§£è¯»
```

### 1.2 è‰ç¨¿ç¡®è®¤æµç¨‹

å½“åˆ†æé˜¶æ®µå®Œæˆåï¼Œç³»ç»Ÿè¿›å…¥ `draft` é˜¶æ®µï¼Œæš‚åœå¤„ç†å¹¶ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼š

**åç«¯å‘é€è‰ç¨¿å®Œæˆäº‹ä»¶** ([`deep-search-analysis/route.ts`](app/api/local-aibot/deep-search-analysis/route.ts:257))ï¼š

```typescript
// å‘é€è‰ç¨¿å®Œæˆäº‹ä»¶
const draftCompleteData = {
    type: 'draft-complete',
    success: true,
    draftMarkdown,
    articleAnalysis: combinedAnalyses
};
controller.enqueue(encoder.encode(`data: ${JSON.stringify(draftCompleteData)}\n\n`));
```

**å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤ºè‰ç¨¿ç¡®è®¤ç•Œé¢** ([`DeepSearchWorkflow.tsx`](components/aibot/DeepSearchWorkflow.tsx:94))ï¼š

```typescript
const processFinalResult = (data: any) => {
    setKeywords(data.keywords || []);
    setDraftMarkdown(data.draftMarkdown);
    setSearchSnippets(data.searchSnippets);
    setPhase('draft');  // è¿›å…¥è‰ç¨¿ç¡®è®¤é˜¶æ®µï¼Œæš‚åœç­‰å¾…ç”¨æˆ·
};
```

### 1.3 ç”¨æˆ·æ“ä½œå›è°ƒæœºåˆ¶

[`DraftConfirmationDisplay.tsx`](components/aibot/DraftConfirmationDisplay.tsx:51) æä¾›äº†å››ä¸ªæ ¸å¿ƒå›è°ƒï¼š

```typescript
interface DraftConfirmationDisplayProps {
    onDraftChange: (value: string) => void;  // è‰ç¨¿ç¼–è¾‘å›è°ƒ
    onConfirm: () => void;                   // ç¡®è®¤æ‰§è¡Œæ£€ç´¢
    onCancel: () => void;                    // å–æ¶ˆæ•´ä¸ªæµç¨‹
    onRegenerate: () => void;                // é‡æ–°ç”Ÿæˆè‰ç¨¿
}
```

**äº¤äº’æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è‰ç¨¿ç¡®è®¤äº¤äº’æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç³»ç»Ÿæ˜¾ç¤ºè‰ç¨¿å†…å®¹ + æºæ•°æ®ï¼ˆå¯å±•å¼€æŸ¥çœ‹ï¼‰                           â”‚
â”‚                                                                     â”‚
â”‚  2. ç”¨æˆ·å¯é€‰æ‹©ï¼š                                                     â”‚
â”‚     â”œâ”€ [ç¼–è¾‘] â†’ è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œä¿®æ”¹è‰ç¨¿å†…å®¹ â”€â”€â–¶ [ä¿å­˜]/[å–æ¶ˆ]         â”‚
â”‚     â”œâ”€ [é‡æ–°ç”Ÿæˆ] â†’ é‡æ–°æ‰§è¡Œæ·±åº¦æ£€ç´¢åˆ†æ                             â”‚
â”‚     â”œâ”€ [å–æ¶ˆ] â†’ ç»ˆæ­¢æ•´ä¸ªæµç¨‹                                         â”‚
â”‚     â””â”€ [ç¡®è®¤æ£€ç´¢] â†’ ç»§ç»­æ‰§è¡Œå›¾ä¹¦æ£€ç´¢ï¼ˆå¿…é¡»è‰ç¨¿éç©ºï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é—®é¢˜2ï¼šæµå¼å¤„ç†ï¼ˆSSEï¼‰å®ç°ç»†èŠ‚

### 2.1 SSE äº‹ä»¶ç±»å‹å®šä¹‰

åç«¯ ([`deep-search-analysis/route.ts`](app/api/local-aibot/deep-search-analysis/route.ts:14)) å®šä¹‰äº†ä¸‰ç§äº‹ä»¶ç±»å‹ï¼š

```typescript
// è¿›åº¦äº‹ä»¶
type ProgressCallback = (phase: string, message: string, status: 'running' | 'completed' | 'error', details?: string) => void;

// å‘é€SSEè¿›åº¦æ›´æ–°
const sendProgress = (controller, phase, message, status, details?) => {
    const progressData = {
        type: 'progress',
        phase,
        message,
        status,
        details,
        timestamp: new Date().toISOString()
    };
    const data = `data: ${JSON.stringify(progressData)}\n\n`;
    controller.enqueue(new TextEncoder().encode(data));
};
```

**SSE äº‹ä»¶æµç¤ºä¾‹**ï¼š

```
data: {"type":"progress","phase":"keyword","message":"æ­£åœ¨ç”Ÿæˆæ£€ç´¢å…³é”®è¯...","status":"running"}

data: {"type":"progress","phase":"search","message":"æ­£åœ¨æ‰§è¡ŒJinaæ£€ç´¢...","status":"running"}

data: {"type":"draft-start","keywords":[...],"searchSnippets":[...],"userInput":"..."}

data: {"type":"draft-chunk","content":"# äº¤å‰åˆ†æç»“æœ...\n"}

data: {"type":"draft-chunk","content":"åŸºäºä»¥ä¸Šåˆ†æ..."}

data: {"type":"draft-complete","success":true,"draftMarkdown":"...","articleAnalysis":"..."}
```

### 2.2 å‰ç«¯ SSE è§£æä¸å®æ—¶æ›´æ–°

[`DeepSearchWorkflow.tsx`](components/aibot/DeepSearchWorkflow.tsx:143) ä¸­çš„è§£æé€»è¾‘ï¼š

```typescript
const reader = response.body?.getReader();
const decoder = new TextDecoder();
let buffer = '';

while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop() || '';
    
    for (const line of lines) {
        if (line.startsWith('data: ')) {
            const data = JSON.parse(line.slice(6));
            
            if (data.type === 'progress') {
                // æ›´æ–°è¿›åº¦æ—¥å¿—
                addLog({
                    phase: data.phase,
                    message: data.message,
                    status: data.status,
                    details: data.details
                });
            } else if (data.type === 'draft-chunk') {
                // æµå¼è¿½åŠ è‰ç¨¿å†…å®¹
                setDraftMarkdown(prev => prev + data.content);
            } else if (data.type === 'draft-complete') {
                // è‰ç¨¿å®Œæˆï¼Œåˆ‡æ¢åˆ°ç¡®è®¤é˜¶æ®µ
                processFinalResult(data);
            }
        }
    }
}
```

### 2.3 äººæœºåä½œé€æ˜åº¦çš„æå‡

æµå¼å¤„ç†å¸¦æ¥çš„é€æ˜åº¦æå‡ä½“ç°åœ¨ä¸‰ä¸ªå±‚é¢ï¼š

| å±‚é¢ | å®ç°æœºåˆ¶ | ç”¨æˆ·æ„ŸçŸ¥ |
|------|---------|---------|
| **è¿›åº¦å¯è§** | æ¯ä¸ªé˜¶æ®µå‘é€ `progress` äº‹ä»¶ | çœ‹åˆ°"æ­£åœ¨ç”Ÿæˆå…³é”®è¯"ã€"æ­£åœ¨æ£€ç´¢"ç­‰çŠ¶æ€ |
| **å®æ—¶è‰ç¨¿** | `draft-chunk` äº‹ä»¶é€å—æ¨é€ | çœ‹åˆ°AIæ€è€ƒè¿‡ç¨‹çš„é€æ­¥å±•å¼€ |
| **é˜¶æ®µæ˜ç¡®** | `draft-start` å’Œ `draft-complete` æ ‡è®° | çŸ¥é“ä½•æ—¶è‰ç¨¿ç”Ÿæˆå®Œæ¯•ï¼Œå¯ä»¥ä»‹å…¥ |

**è¿›åº¦æ—¥å¿—ç»„ä»¶** ([`ProgressLogDisplay.tsx`](components/aibot/ProgressLogDisplay.tsx)) å®æ—¶æ˜¾ç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” æ·±åº¦æ£€ç´¢è¿›åº¦                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ å…³é”®è¯ç”Ÿæˆå®Œæˆ (3ä¸ªå…³é”®è¯)             â”‚
â”‚  âŸ³ æ­£åœ¨æ‰§è¡ŒJinaæ£€ç´¢... (2/3)             â”‚
â”‚  âŸ³ æ­£åœ¨åˆ†æå…³é”®è¯: äººå·¥æ™ºèƒ½æ•™è‚²           â”‚
â”‚  âŸ³ äº¤å‰åˆ†ææ­£åœ¨è¿›è¡Œ...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é—®é¢˜3ï¼šå¤šæ¨¡å¼é›†æˆçš„è·¯ç”±åˆ†å‘

### 3.1 æ„å›¾åˆ†ç±»å™¨æ¶æ„

[`classifier.ts`](src/core/aibot/classifier.ts:112) ä¸­çš„ `classifyUserIntent()` å‡½æ•°ï¼š

```typescript
export async function classifyUserIntent(input: IntentClassifierInput): Promise<IntentClassificationResult> {
    // 1. æ„å»ºåˆ†ç±»æç¤ºè¯
    const prompt = await loadPrompt(AIBOT_PROMPT_FILES.QUESTION_CLASSIFIER);
    
    // 2. è°ƒç”¨LLMè¿›è¡Œåˆ†ç±»ï¼ˆä½¿ç”¨ Gemini Flash æ¨¡å‹ï¼Œtemperature=0ï¼‰
    const result = await generateText({
        model,
        system: prompt,
        prompt: buildClassifierPrompt(input)
    });
    
    // 3. è§£æJSONç»“æœ
    return parseClassifierText(result.text);
}
```

### 3.2 åˆ†ç±»ç»“æœç»“æ„

```typescript
interface IntentClassificationResult {
    intent: 'simple_search' | 'deep_search' | 'document_analysis' | 'other';
    confidence: number;           // ç½®ä¿¡åº¦ 0-1
    reason: string;               // åˆ†ç±»åŸå› è¯´æ˜
    suggestedQuery?: string;      // å»ºè®®çš„ä¼˜åŒ–æŸ¥è¯¢
    source: 'llm' | 'rule';       // ç»“æœæ¥æº
}
```

### 3.3 è·¯ç”±åˆ†å‘é€»è¾‘

[`chat/route.ts`](app/api/local-aibot/chat/route.ts:103) ä¸­çš„ `determineMode()` å‡½æ•°ï¼š

```typescript
const determineMode = (
    intent: IntentClassificationResult['intent'],
    requestedMode: AIBotMode,
    body: ChatRequestPayload
): { mode: AIBotMode; downgraded: boolean } => {
    // ä¼˜å…ˆçº§1ï¼šå¦‚æœæœ‰è‰ç¨¿å†…å®¹ï¼Œå¼ºåˆ¶ä½¿ç”¨æ·±åº¦æ¨¡å¼
    if (hasDeepPayload(body)) {
        return { mode: AIBOT_MODES.DEEP, downgraded: false };
    }
    
    // ä¼˜å…ˆçº§2ï¼šæ ¹æ®æ„å›¾åˆ†ç±»ç»“æœè·¯ç”±
    switch (intent) {
        case 'deep_search':
            return { mode: AIBOT_MODES.DEEP, downgraded: false };
        case 'document_analysis':
            return { mode: AIBOT_MODES.DOCUMENT, downgraded: false };
        case 'simple_search':
        default:
            return { mode: AIBOT_MODES.TEXT, downgraded: false };
    }
};
```

### 3.4 è·¯ç”±å†³ç­–æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ„å›¾åˆ†ç±»ä¸è·¯ç”±åˆ†å‘                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ç”¨æˆ·è¾“å…¥ â”€â”€â–¶ classifyUserIntent() â”€â”€â–¶ åˆ†ç±»ç»“æœ                      â”‚
â”‚                                                                     â”‚
â”‚                            â”‚                                        â”‚
â”‚                            â–¼                                        â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                   â”‚  intent ç±»å‹åˆ¤æ–­ â”‚                               â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                            â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚                  â”‚                  â”‚                     â”‚
â”‚         â–¼                  â–¼                  â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚deep_search  â”‚   â”‚simple_searchâ”‚   â”‚   other     â”‚               â”‚
â”‚  â”‚  æ·±åº¦æ£€ç´¢   â”‚   â”‚  ç®€å•æ£€ç´¢   â”‚   â”‚  æç¤ºå›å¤   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                 â”‚                 â”‚                       â”‚
â”‚         â–¼                 â–¼                 â–¼                       â”‚
â”‚  æ·±åº¦æ£€ç´¢å·¥ä½œæµ    ç®€å•æ£€ç´¢å·¥ä½œæµ    é»˜è®¤å›å¤å¼•å¯¼                     â”‚
â”‚  (6é˜¶æ®µæµç¨‹)      (ç›´æ¥æ£€ç´¢+è§£è¯»)   (å»ºè®®ä¼˜åŒ–æŸ¥è¯¢)                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.5 æ¨¡å¼åˆ‡æ¢çš„æ™ºèƒ½åˆ¤æ–­

[`classifier.ts`](src/core/aibot/classifier.ts:162) ä¸­çš„ `shouldBypassClassifier()` å‡½æ•°å®ç°äº†æ¨¡å¼è¿ç»­æ€§åˆ¤æ–­ï¼š

```typescript
export function shouldBypassClassifier(content: string, previousMode?: AIBotMode): boolean {
    // æ·±åº¦æ¨¡å¼ï¼šæ£€æµ‹ç»§ç»­å…³é”®è¯
    if (previousMode === AIBOT_MODES.DEEP) {
        const CONTINUE_KEYWORDS = ['ç»§ç»­', 'ä¸‹ä¸€æ­¥', 'æ¥ç€', 'ç»§ç»­æ‰§è¡Œ', 'ç¡®è®¤æ‰§è¡Œ'];
        const shouldBypass = trimmed.length <= 24 && CONTINUE_KEYWORDS.some(keyword =>
            trimmed.toLowerCase() === keyword.toLowerCase() ||
            trimmed.toLowerCase().endsWith(keyword.toLowerCase())
        );
        return shouldBypass;
    }
    
    // æ–‡æœ¬æ¨¡å¼ï¼šæ£€æµ‹å¿«é€Ÿç¡®è®¤å…³é”®è¯
    if (previousMode === AIBOT_MODES.TEXT) {
        const QUICK_ACK_KEYWORDS = ['ç»§ç»­', 'ok', 'æ”¶åˆ°'];
        return trimmed.length <= 12 && QUICK_ACK_KEYWORDS.includes(trimmed.toLowerCase());
    }
    
    return false;
}
```

---

## é—®é¢˜4ï¼šé”™è¯¯æ¢å¤ä¸è‰ç¨¿ä¿å­˜

### 4.1 è‰ç¨¿çš„æœ¬åœ°çŠ¶æ€ç®¡ç†

å‰ç«¯ä½¿ç”¨ Zustand store + æœ¬åœ° state å®ç°è‰ç¨¿ç®¡ç†ï¼š

```typescript
// DeepSearchWorkflow.tsx
const [draftMarkdown, setDraftMarkdown] = useState('');

// DraftConfirmationDisplay.tsx - ç¼–è¾‘çŠ¶æ€
const [isEditing, setIsEditing] = useState(false);
const [editValue, setEditValue] = useState('');
```

### 4.2 ç¼–è¾‘ä¸ä¿å­˜æœºåˆ¶

[`DraftConfirmationDisplay.tsx`](components/aibot/DraftConfirmationDisplay.tsx:51) çš„ç¼–è¾‘æµç¨‹ï¼š

```typescript
// è¿›å…¥ç¼–è¾‘æ¨¡å¼
const handleStartEdit = () => {
    setEditValue(cleanedDraft);  // åŠ è½½å½“å‰è‰ç¨¿
    setIsEditing(true);
};

// ä¿å­˜ç¼–è¾‘ç»“æœ
const handleSaveEdit = () => {
    onDraftChange(editValue);    // å›è°ƒæ›´æ–°çˆ¶ç»„ä»¶çŠ¶æ€
    setIsEditing(false);
};

// å–æ¶ˆç¼–è¾‘
const handleCancelEdit = () => {
    setEditValue(cleanedDraft);  // æ¢å¤åŸå§‹å†…å®¹
    setIsEditing(false);
};
```

### 4.3 ç½‘ç»œé”™è¯¯å¤„ç†

**åç«¯é”™è¯¯æ•è·** ([`deep-search-analysis/route.ts`](app/api/local-aibot/deep-search-analysis/route.ts:267))ï¼š

```typescript
try {
    // ... å¤„ç†é€»è¾‘
} catch (error) {
    logger.error('æ·±åº¦æ£€ç´¢åˆ†æå¤±è´¥', { error });
    sendProgress(controller, 'error', 'æ·±åº¦æ£€ç´¢åˆ†æå¤±è´¥', 'error', 
        error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯');
    controller.close();
}
```

**å‰ç«¯é”™è¯¯å¤„ç†** ([`DeepSearchWorkflow.tsx`](components/aibot/DeepSearchWorkflow.tsx:195))ï¼š

```typescript
try {
    // ... SSE è¯»å–
} catch (error) {
    console.error('æ·±åº¦æ£€ç´¢åˆ†æé”™è¯¯:', error);
    addLog({
        phase: 'error',
        message: 'æ·±åº¦æ£€ç´¢åˆ†æå¤±è´¥',
        status: 'error',
        details: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    });
} finally {
    setIsLoading(false);
}
```

### 4.4 ä¸­æ–­æ¢å¤æœºåˆ¶

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æœºåˆ¶å¤„ç†ä¸­æ–­ï¼š

| åœºæ™¯ | æ¢å¤æœºåˆ¶ |
|------|---------|
| **è‰ç¨¿ç”Ÿæˆä¸­æ–­** | `draft-chunk` äº‹ä»¶æµå¼æ¥æ”¶ï¼Œå·²æ¥æ”¶çš„å†…å®¹ä¿å­˜åœ¨ `draftMarkdown` çŠ¶æ€ |
| **ç¡®è®¤é˜¶æ®µä¸­æ–­** | ç”¨æˆ·å¯é‡æ–°æ‰“å¼€ç•Œé¢ï¼Œå·²ç¡®è®¤çš„è‰ç¨¿é€šè¿‡ `deep_metadata` ä¼ é€’ |
| **ç½‘ç»œè¶…æ—¶** | 2ç§’è¶…æ—¶ä¿æŠ¤æœºåˆ¶ ([`DeepSearchWorkflow.tsx`](components/aibot/DeepSearchWorkflow.tsx:177)) |
| **ç”¨æˆ·å–æ¶ˆ** | `handleDraftCancel()` æ¸…ç†çŠ¶æ€å¹¶é€šçŸ¥çˆ¶ç»„ä»¶ |

**è¶…æ—¶ä¿æŠ¤æœºåˆ¶**ï¼š

```typescript
// å¦‚æœæ²¡æ”¶åˆ°äº¤å‰åˆ†æå®Œæˆä¿¡å·ï¼Œ2ç§’åå¼ºåˆ¶æ˜¾ç¤ºè‰ç¨¿
setTimeout(() => {
    if (!hasReceivedCrossAnalysisComplete) {
        console.warn('æœªæ”¶åˆ°äº¤å‰åˆ†æå®Œæˆçš„è¿›åº¦æ›´æ–°ï¼Œå¼ºåˆ¶æ˜¾ç¤ºè‰ç¨¿');
        processFinalResult(data);
        setPendingFinalResult(null);
    }
}, 2000);
```

### 4.5 é‡æ–°ç”ŸæˆåŠŸèƒ½

ç”¨æˆ·å¯ä»¥éšæ—¶é‡æ–°ç”Ÿæˆè‰ç¨¿ ([`DeepSearchWorkflow.tsx`](components/aibot/DeepSearchWorkflow.tsx:326))ï¼š

```typescript
const handleDraftRegenerate = async () => {
    setPhase('analysis');           // é‡ç½®åˆ°åˆ†æé˜¶æ®µ
    setDraftMarkdown('');
    setSearchSnippets([]);
    setBooks([]);
    setSelectedBooks([]);
    setHasReceivedCrossAnalysisComplete(false);
    setPendingFinalResult(null);
    // è‡ªåŠ¨é‡æ–°æ‰§è¡Œåˆ†ææµç¨‹
};
```

---

## æ€»ç»“ï¼šäººåœ¨ç¯äº¤äº’çš„è®¾è®¡å“²å­¦

é€šè¿‡ä»£ç åˆ†æï¼ŒAIBot çš„"äººåœ¨ç¯"è®¾è®¡ä½“ç°äº†**æ¸è¿›å¼äººæœºåä½œ**çš„ç†å¿µï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äººåœ¨ç¯äº¤äº’è®¾è®¡é‡‘å­—å¡”                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                        â”‚  ç”¨æˆ·æŒæ§  â”‚ â† æœ€ç»ˆå†³ç­–æƒ              â”‚
â”‚                        â”‚   ç¡®è®¤æ‰§è¡Œ  â”‚                          â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                              â”‚                                  â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                            â”‚
â”‚                        â”‚  è‰ç¨¿ç¼–è¾‘  â”‚ â† å¹²é¢„æ£€ç´¢æ–¹å‘             â”‚
â”‚                        â”‚  å†…å®¹ä¿®æ­£  â”‚                          â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                              â”‚                                  â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                            â”‚
â”‚                        â”‚  æºæ•°æ®æŸ¥çœ‹â”‚ â† ä¿¡æ¯é€æ˜                 â”‚
â”‚                        â”‚  è´¨é‡æŠŠæ§  â”‚                          â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                              â”‚                                  â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                            â”‚
â”‚                        â”‚  å®æ—¶è¿›åº¦  â”‚ â† è¿‡ç¨‹å¯è§                 â”‚
â”‚                        â”‚  é€æ˜åé¦ˆ  â”‚                          â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™ç§è®¾è®¡ç¡®ä¿äº†ï¼š
1. **AI ä¸æ›¿ä»£äººåšå†³å®š**ï¼Œè€Œæ˜¯æä¾›å»ºè®®å’Œè‰ç¨¿
2. **ç”¨æˆ·å§‹ç»ˆæœ‰æœ€ç»ˆæ§åˆ¶æƒ**ï¼Œå¯ä»¥ä¿®æ”¹ã€ç¡®è®¤æˆ–æ‹’ç»
3. **è¿‡ç¨‹å®Œå…¨é€æ˜**ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°AIçš„æ€è€ƒè¿‡ç¨‹å’Œä¾æ®
4. **æ”¯æŒæ¸è¿›å¼æ·±å…¥**ï¼Œä»ç®€å•æ£€ç´¢åˆ°æ·±åº¦åˆ†æçš„è‡ªç”±åˆ‡æ¢

---

> **æŠ¥å‘Šæ’°å†™å»ºè®®**ï¼šä»¥ä¸Šä»£ç å®ç°ç»†èŠ‚å¯ç›´æ¥ç”¨äºè®ºæ–‡ç¬¬5ç« èŠ‚çš„"äººåœ¨ç¯äº¤äº’"å’Œ"å¤šæ¨¡å¼é›†æˆ"è®ºè¿°ï¼Œå»ºè®®é…åˆæµç¨‹å›¾å’Œä»£ç ç‰‡æ®µå¢å¼ºè¯´æœåŠ›ã€‚